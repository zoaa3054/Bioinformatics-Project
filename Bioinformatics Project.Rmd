---
title: "Bioinformatics Project"
author: "Ibrahim Mohamed Elsayed Moustafa Omar | 21010023\n
        Mohamed Mohamed Mohamed Abdelmonaem | 21011213"
---
```{r}
# Run before commiting
save.image(file = "my_workspace.RData")
```
```{r}
# Run after opening the project
load("my_workspace.RData")
print("Your variables:")
ls()
```
#Reading the data
##Converting .bed .bim .fam files to .map .ped files
![Alt text or caption](plinkCommand.png)

##Converting .map .ped files to .gds files 
```{r}
# install.packages("BiocManager")
# BiocManager::install(c("SNPRelate", "GENESIS", "GWASTools"), force = TRUE)
# install.packages("coxme")
# install.packages("GeneNet")
# install.packages("openxlsx")
# install.packages("qqman")
```
```{r}
library(SNPRelate)

# Define the file names
ped.fn <- "Qatari156_filtered_pruned.ped"
map.fn <- "Qatari156_filtered_pruned.map"
gds.fn <- "Qatari156_filtered_pruned.gds"

# Convert to GDS format
snpgdsPED2GDS(ped.fn, map.fn, out.gdsfn = gds.fn)
# Open the GDS file
genofile <- snpgdsOpen(gds.fn)

# Check the GDS file
snpgdsSummary(genofile)
# Closing the GDS file
snpgdsClose(genofile)
```

##Reading the metabolites data from .csv file
```{r}
metabolites <- read.csv("qatari_metabolites_2025.csv", header = TRUE)

# Check the first few rows of the data
head(metabolites)
```


#Task 1: Compute Kinship using SNPRelate and GENESIS
###Compute IBD Coefficients (Kinship Estimation)
```{r}
# Complete Kinship Analysis Workflow (Verified 2024)
library(SNPRelate)
library(GENESIS)
library(GWASTools)
library(BiocParallel)

# Compute KING kinship with SNPRelate
gds <- snpgdsOpen(gds.fn)
king_kinship <- snpgdsIBDKING(gds, num.thread = 2)
closefn.gds(gds)

# Prepare GENESIS objects
geno <- GdsGenotypeReader(gds.fn)
genoData <- GenotypeData(geno)

# Add sample IDs to kinship matrix
sample_ids <- getScanID(genoData)
kinship_matrix <- king_kinship$kinship
dimnames(kinship_matrix) <- list(sample_ids, sample_ids)

# Run PC-AiR
pca <- pcair(genoData,
        kinobj = kinship_matrix,
        divobj = kinship_matrix,
        kin.thresh = 0.0442,
        div.thresh = -0.0442
)

# Prepare for PC-Relate with current syntax
iterator <- GenotypeBlockIterator(genoData)

# Current working version of pcrelate (as of GENESIS 2.22.0)
pcrelate_results <- pcrelate(iterator,
        pcs = pca$vectors[, 1:2], # Note 'pcs' parameter
        training.set = pca$unrels,
        verbose = TRUE
)

# Get kinship matrix
kinship_matrix <- pcrelateToMatrix(pcrelate_results)

# Clean up
close(genoData)
```
##Report the number of individuals who have a kinship > 0.1
```{r}
# Convert kinship matrix to a regular matrix if it's a Matrix object
if (inherits(kinship_matrix, "Matrix")) {
        kinship_matrix <- as.matrix(kinship_matrix)
}

# Get all pairwise combinations
sample_ids <- rownames(kinship_matrix)
kinship_pairs <- data.frame(
        ID1 = rep(sample_ids, each = length(sample_ids)),
        ID2 = rep(sample_ids, times = length(sample_ids)),
        kinship = as.vector(kinship_matrix),
        stringsAsFactors = FALSE
)

# Remove self-comparisons and keep only unique pairs (upper triangle)
kinship_pairs <- kinship_pairs[kinship_pairs$ID1 != kinship_pairs$ID2, ]
kinship_pairs <- kinship_pairs[!duplicated(t(apply(kinship_pairs[, 1:2], 1, sort))), ]

# Filter for kinship > 0.1
high_kinship <- kinship_pairs[kinship_pairs$kinship > 0.1, ]

# Count results
num_pairs <- nrow(high_kinship)
num_individuals <- length(unique(c(high_kinship$ID1, high_kinship$ID2)))

# Report results
cat("Number of individual pairs with kinship > 0.1:", num_pairs, "\n")
cat("Number of unique individuals involved:", num_individuals, "\n")
```
#Task 2: Compute mQTLs with Mixed Models
```{r}
```
#Task 3: Inflation factor calculation
```{r}
```

#Task 4: Manhattan Plot
```{r}
```

#Task 5: Metabolic Networks
##Correct metabolites for covariates and kinship using polygenic() residuals
```{r}
library(Matrix)
library(coxme) # Load coxme for lmekin

# Create a kinship matrix suitable for lmekin
kin_mat <- as.matrix(kinship_matrix)
kin_mat <- kin_mat[pca$sample.id, pca$sample.id] # Align rows/cols
# Add a small value to the diagonal to ensure positive definiteness
kin_mat <- kin_mat + diag(1e-6, nrow(kin_mat))
# Force kin_mat to be positive semi-definite using nearPD
kin_mat <- as.matrix(Matrix::nearPD(kin_mat)$mat)

corrected_metabs <- data.frame(sample.id = pca$sample.id)

for (metab in colnames(metabolites)) {
        df <- data.frame(
                value = as.numeric(metabolites[[metab]]),
                PC1 = as.numeric(pca$vectors[, 1]),
                PC2 = as.numeric(pca$vectors[, 2]),
                PC3 = as.numeric(pca$vectors[, 3]),
                id = pca$sample.id
        )
        # Remove rows with NA values
        df <- na.omit(df)
        if (nrow(df) == 0) {
                warning(paste("No valid data for metabolite:", metab))
                next
        }
        # Mixed model using kinship as random effect
        model <- lmekin(value ~ PC1 + PC2 + PC3 + (1 | id),
                data = df,
                varlist = kin_mat
        )
        # Residuals = corrected metabolite
        corrected_metabs[[metab]] <- resid(model)
}
```
```{r}
head(corrected_metabs)
```

##Use GeneNet to Compute Partial Correlation Network
```{r}
# Input: corrected_metabs (data.frame with sample.id + metabolite columns)
# Output: Cytoscape-ready network files (edges.csv and nodes.csv)

# 1. Load required package
library(GeneNet)

# 2. Prepare metabolite matrix
metab_data <- corrected_metabs[, !colnames(corrected_metabs) %in% "sample.id", drop = FALSE]
rownames(metab_data) <- corrected_metabs$sample.id

# 3. Clean data - remove zero-variance and mostly-NA metabolites
keep_metabs <- apply(metab_data, 2, function(x) var(x, na.rm = TRUE) > 0)
metab_clean <- metab_data[, keep_metabs, drop = FALSE]
metab_clean <- na.omit(metab_clean) # Remove samples with any NAs

# 4. Compute partial correlations
pcor_matrix <- ggm.estimate.pcor(t(metab_clean), method = "dynamic")
used_metabs <- pcor_matrix
# 5. Test for significant edges
network_test <- network.test.edges(pcor_matrix, fdr = TRUE, direct = TRUE)
print(head(pcor_matrix))
# 6. Create edges data frame - convert indices to names immediately
edges <- data.frame(
        source = used_metabs[network_test$node1],
        target = used_metabs[network_test$node2],
        pcor = network_test$pcor,
        pval = network_test$pval,
        stringsAsFactors = FALSE
)

# 7. Filter significant edges (FDR < 0.05)
sig_edges <- edges[edges$pval < 0.05 & !is.na(edges$pval), ]

# 8. Create nodes data frame
nodes <- data.frame(
        id = used_metabs,
        nodeType = "metabolite",
        stringsAsFactors = FALSE
)

# 9. Save results
write.csv(sig_edges, "metabolite_network_edges.csv", row.names = FALSE)
write.csv(nodes, "metabolite_network_nodes.csv", row.names = FALSE)

# 10. Print summary
cat("Network analysis completed:\n")
cat("-", nrow(metab_clean), "samples\n")
cat("-", length(used_metabs), "metabolites analyzed\n")
cat("-", nrow(sig_edges), "significant edges found\n")
```
##Visualize in Cytoscape
![Alt text or caption](cytoscapeNetwork.png)
##Analyze Network in Cytoscape
```{r}
cytoscapeNetworkAnalysis <- read.csv("cytoscapeNetworkAnalysis.csv", header = TRUE)
print(cytoscapeNetworkAnalysis)
```

#Task 6: Annotate Significant SNPs
```{r}
```
#Task 7: Regional plots using SNIPA
```{r}
```

```{r}
# Close GDS file
close(genoData)
```